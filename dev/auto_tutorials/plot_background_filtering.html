<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Background information on filtering &mdash; MNE 0.13.dev0 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.6/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.13.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="MNE 0.13.dev0 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorials.html" />
    <link rel="next" title="Introduction to artifacts and artifact detection" href="plot_artifacts_detection.html" />
    <link rel="prev" title="Seven stories about MNE" href="../tutorials/seven_stories_about_mne.html" />

<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37225609-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



    <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);
    js.id=id;js.src="http://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>



    <script type="text/javascript">
    (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>


  </head>
  <body role="document">

<div class="devbar">
This documentation is for the development version (0.13.dev0) - <a href="http://martinos.org/mne/stable">Stable version</a>
</div>





  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/mne_logo_small.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b>0.13.dev0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../getting_started.html">Get started</a></li>
                <li><a href="../tutorials.html">Tutorials</a></li>
                <li><a href="../auto_examples/index.html">Gallery</a></li>
                <li><a href="../python_reference.html">API</a></li>
                <li><a href="../manual/index.html">Manual</a></li>
                <li><a href="../faq.html">FAQ</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contribute to MNE</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_reference.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manual/index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What&#8217;s new</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cite.html">How to cite MNE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">Related publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cited.html">Publications from MNE users</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Background information on filtering</a><ul>
<li><a class="reference internal" href="#filtering-basics">Filtering basics</a><ul>
<li><a class="reference internal" href="#designing-fir-filters">Designing FIR filters</a></li>
<li><a class="reference internal" href="#applying-fir-filters">Applying FIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iir-filters">IIR filters</a><ul>
<li><a class="reference internal" href="#designing-iir-filters">Designing IIR filters</a></li>
<li><a class="reference internal" href="#applying-iir-filters">Applying IIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#filtering-in-mne-python">Filtering in MNE-Python</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/mne_logo_small.png" alt="Logo"/>
            </a></p><ul>
<li><a class="reference internal" href="#">Background information on filtering</a><ul>
<li><a class="reference internal" href="#filtering-basics">Filtering basics</a><ul>
<li><a class="reference internal" href="#designing-fir-filters">Designing FIR filters</a></li>
<li><a class="reference internal" href="#applying-fir-filters">Applying FIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iir-filters">IIR filters</a><ul>
<li><a class="reference internal" href="#designing-iir-filters">Designing IIR filters</a></li>
<li><a class="reference internal" href="#applying-iir-filters">Applying IIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#filtering-in-mne-python">Filtering in MNE-Python</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <li>
    <a href="../tutorials/seven_stories_about_mne.html" title="Previous Chapter: Seven stories about MNE"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Seven stories...</span>
    </a>
  </li>
  <li>
    <a href="plot_artifacts_detection.html" title="Next Chapter: Introduction to artifacts and artifact detection"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Introduction ... &raquo;</span>
    </a>
  </li>
<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-12 content">
      
  <div class="section" id="background-information-on-filtering">
<span id="tut-background-filtering"></span><span id="sphx-glr-auto-tutorials-plot-background-filtering-py"></span><h1><a class="toc-backref" href="#id5">Background information on filtering</a><a class="headerlink" href="#background-information-on-filtering" title="Permalink to this headline">¶</a></h1>
<p>Here we give some background information on filtering in general,
and how it is done in MNE-Python in particular.
Recommended reading for practical applications of digital
filter design can be found in <a class="footnote-reference" href="#id4" id="id1">[1]</a>. To see how to use the default filters
in MNE-Python on actual data, see the <a class="reference internal" href="plot_artifacts_correction_filtering.html#tut-artifacts-filter"><span class="std std-ref">Filtering and resampling data</span></a> tutorial.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#background-information-on-filtering" id="id5">Background information on filtering</a><ul>
<li><a class="reference internal" href="#filtering-basics" id="id6">Filtering basics</a><ul>
<li><a class="reference internal" href="#designing-fir-filters" id="id7">Designing FIR filters</a></li>
<li><a class="reference internal" href="#applying-fir-filters" id="id8">Applying FIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iir-filters" id="id9">IIR filters</a><ul>
<li><a class="reference internal" href="#designing-iir-filters" id="id10">Designing IIR filters</a></li>
<li><a class="reference internal" href="#applying-iir-filters" id="id11">Applying IIR filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#filtering-in-mne-python" id="id12">Filtering in MNE-Python</a></li>
<li><a class="reference internal" href="#summary" id="id13">Summary</a></li>
<li><a class="reference internal" href="#references" id="id14">References</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="filtering-basics">
<span id="id2"></span><h2><a class="toc-backref" href="#id6">Filtering basics</a><a class="headerlink" href="#filtering-basics" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s get some of the basic math down. In the frequency domain, digital
filters have a transfer function that is given by:</p>
<div class="math">
\[\begin{split}H(z) &amp;= \frac{b_0 + b_1 z^{-1} + b_2 z^{-2} + ... + b_M z^{-M}}
             {1 + a_1 z^{-1} + a_2 z^{-2} + ... + a_N z^{-M}} \\
     &amp;= \frac{\sum_0^Mb_kz^{-k}}{\sum_1^Na_kz^{-k}}\end{split}\]</div>
<p>In the time domain, the numerator coefficients <span class="math">\(b_k\)</span> and denominator
coefficients <span class="math">\(a_k\)</span> can be used to obtain our output data
<span class="math">\(y(n)\)</span> in terms of our input data <span class="math">\(x(n)\)</span> as:</p>
<div class="math" id="equation-summations">
<span class="eqno">(1)</span>\[\begin{split} y(n) &amp;= b_0 x(n) + b_1 x(n-1) + ... + b_M x(n-M)
         - a_1 y(n-1) - a_2 y(n - 2) - ... - a_N y(n - N)\\
      &amp;= \sum_0^M b_k x(n-k) - \sum_1^N a_k y(n-k)\end{split}\]</div>
<p>In other words, the output at time <span class="math">\(n\)</span> is determined by a sum over:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The numerator coefficients <span class="math">\(b_k\)</span>, which get multiplied by
the previous input <span class="math">\(x(n-k)\)</span> values, and</li>
<li>The denominator coefficients <span class="math">\(a_k\)</span>, which get multiplied by
the previous output <span class="math">\(y(n-k)\)</span> values.</li>
</ol>
</div></blockquote>
<p>Note that these summations in <a href="#equation-summations">(1)</a> correspond nicely to
(1) a weighted <a class="reference external" href="https://en.wikipedia.org/wiki/Moving_average">moving average</a> and (2) an <a class="reference external" href="https://en.wikipedia.org/wiki/Autoregressive_model">autoregression</a>.</p>
<p>Filters are broken into two classes: <a class="reference external" href="https://en.wikipedia.org/wiki/Finite_impulse_response">FIR</a> (finite impulse response) and
<a class="reference external" href="https://en.wikipedia.org/wiki/Infinite_impulse_response">IIR</a> (infinite impulse response) based on these coefficients.
FIR filters use a finite number of numerator
coefficients <span class="math">\(b_k\)</span> (<span class="math">\(\forall k, a_k=0\)</span>), and thus each output
value of <span class="math">\(y(n)\)</span> depends only on the <span class="math">\(M\)</span> previous input values.
IIR filters depend on the previous input and output values, and thus can have
effectively infinite impulse responses.</p>
<p>As outlined in <a class="footnote-reference" href="#id4" id="id3">[1]</a>, FIR and IIR have different tradeoffs:</p>
<blockquote>
<div><ul class="simple">
<li>A causal FIR filter can be linear-phase &#8211; i.e., the same time delay
across all frequencies &#8211; whereas a causal IIR filter cannot. The phase
and group delay characteristics are also usually better for FIR filters.</li>
<li>IIR filters can generally have a steeper cutoff than an FIR filter of
equivalent order.</li>
<li>IIR filters are generally less numerically stable, in part due to
accumulating error (due to its recursive calculations).</li>
</ul>
</div></blockquote>
<p>When designing a filter (FIR or IIR), there are always tradeoffs that
need to be considered, including but not limited to:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Ripple in the pass-band</li>
<li>Attenuation of the stop-band</li>
<li>Steepness of roll-off</li>
<li>Filter order (i.e., length for FIR filters)</li>
<li>Time-domain ringing</li>
</ol>
</div></blockquote>
<p>In general, the sharper something is in frequency, the broader it is in time,
and vice-versa. This is a fundamental time-frequency tradeoff, and it will
show up below.</p>
<hr class="docutils" />
<p>First we will focus first on FIR filters, which are the default filters used by
MNE-Python.</p>
<div class="section" id="designing-fir-filters">
<h3><a class="toc-backref" href="#id7">Designing FIR filters</a><a class="headerlink" href="#designing-fir-filters" title="Permalink to this headline">¶</a></h3>
<p>Here we&#8217;ll try designing a low-pass filter, and look at trade-offs in terms
of time- and frequency-domain filter characteristics. Later, in
<a class="reference internal" href="#effect-on-signals"><span class="std std-ref">Applying FIR filters</span></a>, we&#8217;ll look at how such filters can affect
signals when they are used.</p>
<p>First let&#8217;s import some useful tools for filtering, and set some default
values for our data that are reasonable for M/EEG data.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">fftpack</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">mne.time_frequency.tfr</span> <span class="kn">import</span> <a href="../generated/mne.time_frequency.morlet.html#mne.time_frequency.morlet"><span class="n">morlet</span></a>

<span class="kn">import</span> <span class="nn">mne</span>

<span class="n">sfreq</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">f_p</span> <span class="o">=</span> <span class="mf">40.</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># for dB plots</span>
<span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>
<span class="n">blue</span> <span class="o">=</span> <span class="s1">&#39;#1f77b4&#39;</span>
</pre></div>
</div>
<p>Take for example an ideal low-pass filter, which would give a value of 1 in
the pass-band (up to frequency <span class="math">\(f_p\)</span>) and a value of 0 in the stop-band
(down to frequency <span class="math">\(f_s\)</span>) such that <span class="math">\(f_p=f_s=40\)</span> Hz here
(shown to a lower limit of -60 dB for simplicity):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">nyq</span> <span class="o">=</span> <span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># the Nyquist frequency is half our sample rate</span>
<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">nyq</span><span class="p">]</span>
<span class="n">gain</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">box_off</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_ideal</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">freq</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.maximum.html#numpy.maximum"><span class="n">np</span><span class="o">.</span><span class="n">maximum</span></a><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)):</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">gain</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gain</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">xs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">freq</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">ys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.log10.html#numpy.log10"><span class="n">np</span><span class="o">.</span><span class="n">log10</span></a><span class="p">(</span><a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.maximum.html#numpy.maximum"><span class="n">np</span><span class="o">.</span><span class="n">maximum</span></a><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Amplitude (dB)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticklabels</span><span class="o">=</span><span class="n">xticks</span><span class="p">)</span>
    <span class="n">box_off</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">half_height</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.array.html#numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">(</span><a href="http://matplotlib.org/api/matplotlib_configuration_api.html#matplotlib.rcParams"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span></a><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">half_height</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot_ideal</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ideal </span><span class="si">%s</span><span class="s1"> Hz lowpass&#39;</span> <span class="o">%</span> <span class="n">f_p</span><span class="p">)</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_001.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_001.png" />
<p>This filter hypothetically achieves zero ripple in the frequency domain,
perfect attenuation, and perfect steepness. However, due to the discontunity
in the frequency response, the filter would require infinite ringing in the
time domain (i.e., infinite order) to be realized. Another way to think of
this is that a rectangular window in frequency is actually <a class="reference external" href="https://en.wikipedia.org/wiki/Sinc_function">sinc</a> function
in time, which requires an infinite number of samples, and thus infinite
time, to represent. So although this filter has ideal frequency suppression,
it has poor time-domain characteristics.</p>
<p>Let&#8217;s try to naïvely make a brick-wall filter of length 0.1 sec, and look
at the filter itself in the time domain and the frequency domain:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">t</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sfreq</span>  <span class="c1"># center our sinc</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.sinc.html#numpy.sinc"><span class="n">np</span><span class="o">.</span><span class="n">sinc</span></a><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">f_p</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># second-order sections</span>
        <span class="n">sos</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">estimate_ringing_samples</span><span class="p">(</span><span class="n">sos</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.zeros.html#numpy.zeros"><span class="n">np</span><span class="o">.</span><span class="n">zeros</span></a><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.sosfilt.html#scipy.signal.sosfilt"><span class="n">signal</span><span class="o">.</span><span class="n">sosfilt</span></a><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.ones.html#numpy.ones"><span class="n">np</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sos</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">this_H</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.freqz.html#scipy.signal.freqz"><span class="n">signal</span><span class="o">.</span><span class="n">freqz</span></a><span class="p">(</span><span class="n">section</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">section</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">H</span> <span class="o">*=</span> <span class="n">this_H</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.freqz.html#scipy.signal.freqz"><span class="n">signal</span><span class="o">.</span><span class="n">freqz</span></a><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="o">/</span> <span class="n">sfreq</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">blue</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">t</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (sec)&#39;</span><span class="p">,</span>
               <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Amplitude h(n)&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">*=</span> <span class="n">sfreq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.log10.html#numpy.log10"><span class="n">np</span><span class="o">.</span><span class="n">log10</span></a><span class="p">((</span><span class="n">H</span> <span class="o">*</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">plot_ideal</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>

<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Sinc (0.1 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_002.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_002.png" />
<p>This is not so good! Making the filter 10 times longer (1 sec) gets us a
bit better stop-band suppression, but still has a lot of ringing in
the time domain. Note the x-axis is an order of magnitude longer here:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">t</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sfreq</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.sinc.html#numpy.sinc"><span class="n">np</span><span class="o">.</span><span class="n">sinc</span></a><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">f_p</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Sinc (1.0 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_003.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_003.png" />
<p>Let&#8217;s make the stop-band tighter still with a longer filter (10 sec),
with a resulting larger x-axis:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">10.</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">t</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sfreq</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.sinc.html#numpy.sinc"><span class="n">np</span><span class="o">.</span><span class="n">sinc</span></a><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">f_p</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Sinc (10.0 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_004.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_004.png" />
<p>Now we have very sharp frequency suppression, but our filter rings for the
entire second. So this naïve method is probably not a good way to build
our low-pass filter.</p>
<p>Fortunately, there are multiple established methods to design FIR filters
based on desired response characteristics. These include:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The <a class="reference external" href="https://en.wikipedia.org/wiki/Remez_algorithm">Remez</a> algorithm (<a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.remez.html#noqa">scipy remez</a>, <a class="reference external" href="http://www.mathworks.com/help/signal/ref/firpm.html">MATLAB firpm</a>)</li>
<li>Windowed FIR design (<a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.firwin2.html#noqa">scipy firwin2</a>, <a class="reference external" href="http://www.mathworks.com/help/signal/ref/fir2.html">MATLAB fir2</a>)</li>
<li>Least squares designs (<a class="reference external" href="http://www.mathworks.com/help/signal/ref/firls.html">MATLAB firls</a>; coming to scipy 0.18)</li>
</ol>
</div></blockquote>
<p>If we relax our frequency-domain filter requirements a little bit, we can
use these functions to construct a lowpass filter that instead has a
<em>transition band</em>, or a region between the pass frequency <span class="math">\(f_p\)</span>
and stop frequency <span class="math">\(f_s\)</span>, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">trans_bandwidth</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 10 Hz transition band</span>
<span class="n">f_s</span> <span class="o">=</span> <span class="n">f_p</span> <span class="o">+</span> <span class="n">trans_bandwidth</span>  <span class="c1"># = 50 Hz</span>

<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">nyq</span><span class="p">]</span>
<span class="n">gain</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">half_height</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot_ideal</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Hz lowpass with a </span><span class="si">%s</span><span class="s1"> Hz transition&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f_p</span><span class="p">,</span> <span class="n">trans_bandwidth</span><span class="p">))</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_005.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_005.png" />
<p>Accepting a shallower roll-off of the filter in the frequency domain makes
our time-domain response potentially much better. We end up with a
smoother slope through the transition region, but a <em>much</em> cleaner time
domain signal. Here again for the 1 sec filter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">nyq</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Windowed 10-Hz transition (1.0 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_006.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_006.png" />
<p>Since our lowpass is around 40 Hz with a 10 Hz transition, we can actually
use a shorter filter (5 cycles at 10 Hz = 0.5 sec) and still get okay
stop-band attenuation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sfreq</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">nyq</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Windowed 10-Hz transition (0.5 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_007.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_007.png" />
<p>But then if we shorten the filter too much (2 cycles of 10 Hz = 0.2 sec),
our effective stop frequency gets pushed out past 60 Hz:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sfreq</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">nyq</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Windowed 10-Hz transition (0.2 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_008.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_008.png" />
<p>If we want a filter that is only 0.1 seconds long, we should probably use
something more like a 25 Hz transition band (0.2 sec = 5 cycles &#64; 25 Hz):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">trans_bandwidth</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">f_s</span> <span class="o">=</span> <span class="n">f_p</span> <span class="o">+</span> <span class="n">trans_bandwidth</span>
<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">nyq</span><span class="p">]</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">nyq</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Windowed 50-Hz transition (0.2 sec)&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_009.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_009.png" />
</div>
<div class="section" id="applying-fir-filters">
<span id="effect-on-signals"></span><h3><a class="toc-backref" href="#id8">Applying FIR filters</a><a class="headerlink" href="#applying-fir-filters" title="Permalink to this headline">¶</a></h3>
<p>Now lets look at some practical effects of these filters by applying
them to some data.</p>
<p>Let&#8217;s construct a Gaussian-windowed sinusoid (i.e., Morlet imaginary part)
plus noise (random + line). Note that the original, clean signal contains
frequency content in both the pass band and transition bands of our
low-pass filter.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">dur</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">center</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="n">morlet_freq</span> <span class="o">=</span> <span class="n">f_p</span>
<span class="n">tlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">center</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">center</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">tticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">,</span> <span class="n">tlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">flim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.zeros.html#numpy.zeros"><span class="n">np</span><span class="o">.</span><span class="n">zeros</span></a><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sfreq</span> <span class="o">*</span> <span class="n">dur</span><span class="p">))</span>
<span class="n">blip</span> <span class="o">=</span> <a href="../generated/mne.time_frequency.morlet.html#mne.time_frequency.morlet"><span class="n">morlet</span></a><span class="p">(</span><span class="n">sfreq</span><span class="p">,</span> <span class="p">[</span><span class="n">morlet_freq</span><span class="p">],</span> <span class="n">n_cycles</span><span class="o">=</span><span class="mi">7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span> <span class="o">/</span> <span class="mf">20.</span>
<span class="n">n_onset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span> <span class="o">*</span> <span class="n">sfreq</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">blip</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">x</span><span class="p">[</span><span class="n">n_onset</span><span class="p">:</span><span class="n">n_onset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">blip</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">blip</span>
<span class="n">x_orig</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">rng</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.random.RandomState.wald.html#numpy.random.RandomState"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1000.</span>
<span class="n">x</span> <span class="o">+=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.sin.html#numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">60.</span> <span class="o">*</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">sfreq</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2000.</span>
</pre></div>
</div>
<p>Filter it with a shallow cutoff, linear-phase FIR and compensate for
the delay:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">transition_band</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">f_p</span>
<span class="n">f_s</span> <span class="o">=</span> <span class="n">f_p</span> <span class="o">+</span> <span class="n">transition_band</span>
<span class="n">filter_dur</span> <span class="o">=</span> <span class="mf">5.</span> <span class="o">/</span> <span class="n">transition_band</span>  <span class="c1"># sec</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sfreq</span> <span class="o">*</span> <span class="n">filter_dur</span><span class="p">)</span>
<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>
<span class="n">gain</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
<span class="n">x_shallow</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.convolve.html#numpy.convolve"><span class="n">np</span><span class="o">.</span><span class="n">convolve</span></a><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span>
</pre></div>
</div>
<p>Now let&#8217;s filter it with the MNE-Python 0.12 defaults, which is a
long-duration, steep cutoff FIR:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">transition_band</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Hz</span>
<span class="n">f_s</span> <span class="o">=</span> <span class="n">f_p</span> <span class="o">+</span> <span class="n">transition_band</span>
<span class="n">filter_dur</span> <span class="o">=</span> <span class="mf">10.</span>  <span class="c1"># sec</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sfreq</span> <span class="o">*</span> <span class="n">filter_dur</span><span class="p">)</span>
<span class="n">freq</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>
<span class="n">gain</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
<span class="n">h</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.firwin2.html#scipy.signal.firwin2"><span class="n">signal</span><span class="o">.</span><span class="n">firwin2</span></a><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">nyq</span><span class="o">=</span><span class="n">sfreq</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
<span class="n">x_steep</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.convolve.html#numpy.convolve"><span class="n">np</span><span class="o">.</span><span class="n">convolve</span></a><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span>

<span class="n">plot_filter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;MNE-Python 0.12 default&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_010.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_010.png" />
<p>It has excellent frequency attenuation, but this comes at a cost of potential
ringing (long-lasting ripples) in the time domain. Ripple can occur with
steep filters, especially on signals with frequency content around the
transition band. Our Morlet wavelet signal has power in our transition band,
and the time-domain ringing is thus more pronounced for the steep-slope,
long-duration filter than the shorter, shallower-slope filter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">axs</span> <span class="o">=</span> <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">plot_signal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">sfreq</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (sec)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">t</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.fftpack.fftfreq.html#scipy.fftpack.fftfreq"><span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span></a><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">sfreq</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">freqs</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.log10.html#numpy.log10"><span class="n">np</span><span class="o">.</span><span class="n">log10</span></a><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">)</span>

<span class="n">yticks</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="mf">30.</span>
<span class="n">yticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="s1">&#39;Noisy&#39;</span><span class="p">,</span> <span class="s1">&#39;FIR-shallow&#39;</span><span class="p">,</span> <span class="s1">&#39;FIR-steep&#39;</span><span class="p">]</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_shallow</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_steep</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">tlim</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Lowpass=</span><span class="si">%d</span><span class="s1"> Hz&#39;</span> <span class="o">%</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">tticks</span><span class="p">,</span>
           <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">],</span> <span class="n">yticks</span><span class="o">=</span><span class="n">yticks</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">yticklabels</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
    <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">flim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
<span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_011.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_011.png" />
</div>
</div>
<div class="section" id="iir-filters">
<h2><a class="toc-backref" href="#id9">IIR filters</a><a class="headerlink" href="#iir-filters" title="Permalink to this headline">¶</a></h2>
<p>MNE-Python also offers IIR filtering functionality that is based on the
methods from <a class="reference external" href="http://scipy.github.io/devdocs/signal.html#module-scipy.signal" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-mod docutils literal"><span class="pre">scipy.signal</span></code></a>. Specifically, we use the general-purpose
functions <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.iirfilter()</span></code></a> and <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.iirdesign.html#scipy.signal.iirdesign" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.iirdesign()</span></code></a>,
which provide unified interfaces to IIR filter design.</p>
<div class="section" id="designing-iir-filters">
<h3><a class="toc-backref" href="#id10">Designing IIR filters</a><a class="headerlink" href="#designing-iir-filters" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s continue with our design of a 40 Hz low-pass filter, and look at
some trade-offs of different IIR filters.</p>
<p>Often the default IIR filter is a <a class="reference external" href="https://en.wikipedia.org/wiki/Butterworth_filter">Butterworth filter</a>, which is designed
to have a <em>maximally flat pass-band</em>. Let&#8217;s look at a few orders of filter,
i.e., a few different number of coefficients used and therefore steepness
of the filter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sos</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter"><span class="n">signal</span><span class="o">.</span><span class="n">iirfilter</span></a><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">f_p</span> <span class="o">/</span> <span class="n">nyq</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="s1">&#39;Butterworth order=2&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>

<span class="c1"># Eventually this will just be from scipy signal.sosfiltfilt, but 0.18 is</span>
<span class="c1"># not widely adopted yet (as of June 2016), so we use our wrapper...</span>
<span class="n">sosfiltfilt</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">fixes</span><span class="o">.</span><span class="n">get_sosfiltfilt</span><span class="p">()</span>
<span class="n">x_shallow</span> <span class="o">=</span> <span class="n">sosfiltfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_012.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_012.png" />
<p>The falloff of this filter is not very steep.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For brevity, we do not show the phase of these filters here.
In the FIR case, we can design linear-phase filters, and
compensate for the delay if necessary. This cannot be done
with IIR filters, and as the filter order increases, the
phase distortion near and in the transition band worsens.
However, if acausal (forward-backward) filtering can be used,
e.g. with <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.filtfilt.html#scipy.signal.filtfilt" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.filtfilt()</span></code></a>, these phase issues
can be mitigated.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Here we have made use of second-order sections (SOS)
by using <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.sosfilt.html#scipy.signal.sosfilt" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.sosfilt()</span></code></a> and, under the
hood, <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.zpk2sos.html#scipy.signal.zpk2sos" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.zpk2sos()</span></code></a> when passing the
<code class="docutils literal"><span class="pre">output='sos'</span></code> keyword argument to
<a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.iirfilter()</span></code></a>. The filter definitions
given in <a class="reference internal" href="#filtering-basics"><span class="std std-ref">Filtering basics</span></a> use the polynomial
numerator/denominator (sometimes called &#8220;tf&#8221;) form <code class="docutils literal"><span class="pre">(b,</span> <span class="pre">a)</span></code>,
which are theoretically equivalent to the SOS form used here.
In practice, however, the SOS form can give much better results
due to issues with numerical precision (see
<a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.sosfilt.html#scipy.signal.sosfilt" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.sosfilt()</span></code></a> for an example), so SOS should be
used when possible to do IIR filtering.</p>
</div>
<p>Let&#8217;s increase the order, and note that now we have better attenuation,
with a longer impulse response:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sos</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter"><span class="n">signal</span><span class="o">.</span><span class="n">iirfilter</span></a><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">f_p</span> <span class="o">/</span> <span class="n">nyq</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="s1">&#39;Butterworth order=8&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
<span class="n">x_steep</span> <span class="o">=</span> <span class="n">sosfiltfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_013.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_013.png" />
<p>There are other types of IIR filters that we can use. For a complete list,
check out the documentation for <a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.iirdesign.html#scipy.signal.iirdesign" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.iirdesign()</span></code></a>. Let&#8217;s
try a Chebychev (type I) filter, which trades off ripple in the pass-band
to get better attenuation in the stop-band:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sos</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter"><span class="n">signal</span><span class="o">.</span><span class="n">iirfilter</span></a><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">f_p</span> <span class="o">/</span> <span class="n">nyq</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;cheby1&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">,</span>
                       <span class="n">rp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># dB of acceptable pass-band ripple</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="s1">&#39;Chebychev-1 order=8, ripple=1 dB&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_014.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_014.png" />
<p>And if we can live with even more ripple, we can get it slightly steeper,
but the impulse response begins to ring substantially longer (note the
different x-axis scale):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sos</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.17.0/reference/generated/scipy.signal.iirfilter.html#scipy.signal.iirfilter"><span class="n">signal</span><span class="o">.</span><span class="n">iirfilter</span></a><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">f_p</span> <span class="o">/</span> <span class="n">nyq</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;cheby1&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">,</span>
                       <span class="n">rp</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plot_filter</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="s1">&#39;Chebychev-1 order=8, ripple=6 dB&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">gain</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_015.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_015.png" />
</div>
<div class="section" id="applying-iir-filters">
<h3><a class="toc-backref" href="#id11">Applying IIR filters</a><a class="headerlink" href="#applying-iir-filters" title="Permalink to this headline">¶</a></h3>
<p>Now let&#8217;s look at how our shallow and steep Butterworth IIR filters
perform on our Morlet signal from before:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">axs</span> <span class="o">=</span> <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">yticks</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="mf">30.</span>
<span class="n">yticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="s1">&#39;Noisy&#39;</span><span class="p">,</span> <span class="s1">&#39;Butterworth-2&#39;</span><span class="p">,</span> <span class="s1">&#39;Butterworth-8&#39;</span><span class="p">]</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_shallow</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plot_signal</span><span class="p">(</span><span class="n">x_steep</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">yticks</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">tlim</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Lowpass=</span><span class="si">%d</span><span class="s1"> Hz&#39;</span> <span class="o">%</span> <span class="n">f_p</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">tticks</span><span class="p">,</span>
           <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">],</span> <span class="n">yticks</span><span class="o">=</span><span class="n">yticks</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">yticklabels</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
    <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">flim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Magnitude (dB)&#39;</span><span class="p">)</span>
<span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">box_off</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_background_filtering_016.png" class="align-center" src="../_images/sphx_glr_plot_background_filtering_016.png" />
</div>
</div>
<div class="section" id="filtering-in-mne-python">
<h2><a class="toc-backref" href="#id12">Filtering in MNE-Python</a><a class="headerlink" href="#filtering-in-mne-python" title="Permalink to this headline">¶</a></h2>
<p>Most often, filtering in MNE-Python is done at the <a class="reference internal" href="../generated/mne.io.Raw.html#mne.io.Raw" title="mne.io.Raw"><code class="xref py py-class docutils literal"><span class="pre">mne.io.Raw</span></code></a> level,
and thus <a class="reference internal" href="../generated/mne.io.Raw.html#mne.io.Raw.filter" title="mne.io.Raw.filter"><code class="xref py py-func docutils literal"><span class="pre">mne.io.Raw.filter()</span></code></a> is used. This function under the hood
(among other things) calls <a class="reference internal" href="../generated/mne.filter.filter_data.html#mne.filter.filter_data" title="mne.filter.filter_data"><code class="xref py py-func docutils literal"><span class="pre">mne.filter.filter_data()</span></code></a> to actually
filter the data.</p>
<p><a class="reference internal" href="../generated/mne.filter.filter_data.html#mne.filter.filter_data" title="mne.filter.filter_data"><code class="xref py py-func docutils literal"><span class="pre">mne.filter.filter_data()</span></code></a> by default applies a FIR filter designed using
<a class="reference external" href="http://scipy.github.io/devdocs/generated/scipy.signal.firwin2.html#scipy.signal.firwin2" title="(in SciPy v0.19.0.dev0+7a46deb)"><code class="xref py py-func docutils literal"><span class="pre">scipy.signal.firwin2()</span></code></a>. For more information on how to use the
MNE-Python filtering functions with real data, consult the preprocessing
tutorial on <a class="reference internal" href="plot_artifacts_correction_filtering.html#tut-artifacts-filter"><span class="std std-ref">Filtering and resampling data</span></a>.</p>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id13">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>When filtering, there are always tradeoffs that should be considered.
One important tradeoff is between time-domain characteristics (like ringing)
and frequency-domain attenuation characteristics (like effective transition
bandwidth). Filters with sharp frequency cutoffs can produce outputs that
ring for a long time when they operate on signals with frequency content
in the transition band. In general, therefore, the wider a transition band
that can be tolerated, the better behaved the filter will be in the time
domain.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#id14">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> Parks TW, Burrus CS. Digital Filter Design.
New York: Wiley-Interscience, 1987.</td></tr>
</tbody>
</table>
<p><strong>Total running time of the script:</strong>
(0 minutes 6.213 seconds)</p>
<div class="sphx-glr-download container">
<strong>Download Python source code:</strong> <a class="reference download internal" href="../_downloads/plot_background_filtering.py" download=""><code class="xref download docutils literal"><span class="pre">plot_background_filtering.py</span></code></a></div>
<div class="sphx-glr-download container">
<strong>Download IPython notebook:</strong> <a class="reference download internal" href="../_downloads/plot_background_filtering.ipynb" download=""><code class="xref download docutils literal"><span class="pre">plot_background_filtering.ipynb</span></code></a></div>
<p class="sphx-glr-signature"><a class="reference external" href="http://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>
</div>


    </div>
    
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2012-2016, MNE Developers. Last updated on 2016-07-06.<br/>
    </p>
  </div>
</footer>
  </body>
</html>